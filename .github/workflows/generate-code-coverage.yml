# Copyright 2023 Democratized Data Foundation
#
# Use of this software is governed by the Business Source License
# included in the file licenses/BSL.txt.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0, included in the file
# licenses/APL.txt.

name: Generate Code Coverage Workflow

on:
  pull_request:
    branches:
      - master
      - develop

  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches:
      - master
      - develop
      - Develop
      - ci/separate-code-coverage-to-access-token

env:
  RELEVANT_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
  CODECOV_SECRET: ${{ secrets.CODECOV_TOKEN }}
  WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}

jobs:
  generate-code-coverage:
    name: Generate code coverage job

    runs-on: ubuntu-latest

    steps:
      - name: Echo the relevant commit SHA
        run: |
          echo "Workflow run id=[${WORKFLOW_RUN_ID}]\n"
          echo "Relevant commit SHA=[${RELEVANT_SHA}]\n"
          echo "PR_SHA=[${{github.event.pull_request.head.sha}}]\n"
          echo "GH_SHA=[${{github.sha}}]\n"


      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go environment explicitly
        uses: actions/setup-go@v3
        with:
          go-version: "1.19"
          check-latest: true

      - name: Generate full test coverage report
        # run: make test:coverage
        run: |
          echo "HelloFrom=[${RELEVANT_SHA}]" > coverage.txt
          cat coverage.txt

      - name: Save coverage report as artifact
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-artifact-${{ env.RELEVANT_SHA }}
          path: coverage.txt
          retention-days: 90

